<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDT Scanner</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding: 10px; }
#reader { width: 100%; margin-bottom: 20px; }
.item { border-bottom:1px solid #ccc; padding:8px; font-size:18px; }
</style>
</head>

<body>

<h2>PDT Scanner</h2>
<input type="file" id="excelFile"><br><br>

<div id="reader"></div>

<h3>Son Okutulan</h3>
<div id="lastScan"></div>

<script>
// DOM elementler
const excelFile = document.getElementById("excelFile");
const lastScan = document.getElementById("lastScan");

// Durum
let targetData = {};
let lastBarcode = "";
let lastTime = 0;

// Barkod normalize fonksiyonu
function normalizeBarcode(v){
    if(!v) return "";
    let s = String(v).replace(/\s+/g,"");   // boşlukları kaldır
    if(/^\d+$/.test(s) && s.length < 13) s = s.padStart(13,"0"); // sayı ise başa sıfır ekle
    return s;
}

// Yardımcı fonksiyonlar
function pick(row, names){ for(let n of names) if(row[n] !== undefined) return row[n]; return ""; }
function playError(){ navigator.vibrate(200); new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play(); }
function playSuccess(){ navigator.vibrate(60); }

// Excel yükleme
excelFile.addEventListener("change", async function(){
    let file = this.files[0];
    if(!file) return;
    let wb = XLSX.read(await file.arrayBuffer());
    let rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    targetData = {};
    rows.forEach(r=>{
        let bc = normalizeBarcode(pick(r, ["Barkod","Barcode","EAN"]));
        if(!bc) return;
        targetData[bc] = {
            name: pick(r, ["Ürün Adı","Product Name","Description"]) || "-",
            brand: pick(r, ["Marka","Brand"]) || "-",
            target: Number(pick(r, ["Miktar","Qty","Quantity"])) || 0,
            collected: 0
        };
    });
    alert("Excel yüklendi. SKU sayısı: "+Object.keys(targetData).length);
    startScanner();
});

// Scanner başlat
function startScanner(){
    const scanner = new Html5Qrcode("reader");
    scanner.start(
        { facingMode: "environment" },
        { fps: 12, qrbox: { width: 250, height: 250 } },
        function(decodedText){
            let bc = normalizeBarcode(decodedText);
            let now = Date.now();
            if(bc === lastBarcode && now - lastTime < 800) return;
            lastBarcode = bc;
            lastTime = now;

            if(!targetData[bc]){
                playError();
                lastScan.innerHTML = "<div class='item' style='color:red'>Listede YOK<br>"+bc+"</div>";
                return;
            }

            targetData[bc].collected++;
            playSuccess();
            showLast(bc);
        }
    );
}

// Son okutulan gösterimi
function showLast(bc){
    let p = targetData[bc];
    lastScan.innerHTML = "<div class='item'>"+
        "<b>"+p.name+"</b><br>"+
        p.brand+"<br>"+
        bc+"<br>"+
        p.collected+" / "+p.target+
        "</div>";
}

// Service Worker kaydı (PWA)
if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('service-worker.js')
        .then(reg=>console.log("Service Worker kayıtlı.", reg))
        .catch(err=>console.log("SW hatası:", err));
    });
}
</script>

</body>
</html>
