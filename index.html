<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>PDT Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding: 10px; }
#reader { width:100%; }
.item { border-bottom:1px solid #ccc; padding:8px; font-size:18px; }
</style>

</head>

<body>

<h2>PDT Scanner</h2>

<input type="file" id="excelFile"><br><br>

<div id="reader"></div>

<h3>Son Okutulan</h3>
<div id="lastScan"></div>

<script>

let targetData = {};
let lastBarcode="";
let lastTime=0;

function pad13(v){
return String(v).replace(/\D/g,"").padStart(13,"0");
}

function pick(row,names){
for(let n of names){
 if(row[n] !== undefined) return row[n];
}
return "";
}

excelFile.addEventListener("change", loadExcel);

async function loadExcel(){

let file = excelFile.files[0];
let wb = XLSX.read(await file.arrayBuffer());
let rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

targetData={};

rows.forEach(r=>{

let bc = pick(r, ["Barkod","Barcode","EAN"]);
let name = pick(r, ["Ürün Adı","Product Name","Description"]);
let brand = pick(r, ["Marka","Brand"]);
let qty = pick(r, ["Miktar","Qty","Quantity"]);

if(!bc) return;

bc = pad13(bc);

targetData[bc]={
 name:name||"-",
 brand:brand||"-",
 target:Number(qty)||0,
 collected:0
};

});

alert("Excel yüklendi SKU: "+Object.keys(targetData).length);

startScanner();
}

function playError(){
navigator.vibrate(200);
new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
}

function playSuccess(){
navigator.vibrate(60);
}

function startScanner(){

const scanner = new Html5Qrcode("reader");

scanner.start(
{ facingMode:"environment" },
{
 fps:12,
 qrbox:{ width:280, height:180 }
},
onScanSuccess
);

}

function onScanSuccess(decodedText){

let bc = pad13(decodedText);

let now = Date.now();
if(bc===lastBarcode && now-lastTime<800) return;

lastBarcode=bc;
lastTime=now;

if(!targetData[bc]){

navigator.vibrate(200);

lastScan.innerHTML =
"<div class='item' style='color:red'>" +
"Listede YOK<br>" +
bc +
"</div>";

return;
}

targetData[bc].collected++;

navigator.vibrate(60);

showLast(bc);
}


function showLast(bc){

let p = targetData[bc];

lastScan.innerHTML =
"<div class='item'>" +
"<b>"+p.name+"</b><br>" +
p.brand+"<br>" +
bc+"<br>" +
p.collected+" / "+p.target +
"</div>";
}

</script>
</body>
</html>

